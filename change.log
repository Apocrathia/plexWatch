# 0.0.18-dev
#
# * MyPlex Login Token: The script can now be ran from any computer.
#	-- Specify a $myPlex_user and $myPlex_pass in config.pl
#       -- Will only retrieve a token from my.plexapp.com if the PMS server returns a 401 (authorization required)
# * format_options update/new:
#    -- {streamtype} [T|D] for Transcoded/Direct
#    -- {transcoded} [1|0] for Transcoded/Direct
#    -- {percent_complete} - percent of video watched ( not dependent on time watched, but where progress of video/length.
#    -- {state} - playing/paused/buffering
#    -- {progress} - exact time spot the user is at  (I.E. "15 minutes" )
# * XML is now updated on every run -- allows us to view current state of content ( i.e. paused, playing, percent_completed, etc)
# * CheckLock fixed: script can NOT to be ran multiple times at once (fixed repeat notifications when providers are offline)
# * Provider notifications: timeout is now 20 seconds instead of 3 minutes (we should not wait 3 minutes to reach a provider!)
# * Backup SQLite DB
#    -- automatically happens daily, weekly and monthly
#    -- force Daily backup with --backup


# 0.0.17
# * GNTP: Provider added.
#       -- Supports multiple destinations.
#	-- Currently tested with Growl For Windows as I don't have OSX available. Need to test with others
#	-- install centos ( yum install perl\(Data::UUID\) , cpan Growl::GNTP )   -- CPAN install failed until I installed perl\(Data::UUID\)
#	-- install Ubuntu ( cpan Growl::GNTP )
# * --recently_added allows comma separated list. --recently_added=movie,show   ( preferred way if you are running multiple cron jobs for RA )
#      -- fixes some SQLite lock issues by running it once
#      -- fixes out of order content when running shows/movies
# * fixed --test_notify=  -- now works with =start, =stop, =recently_added
# * cleanup of empty variables for notification: stripping "[]" from alert.
# * excluding length of video from notification when Plex API doesn't return length: (00 min)
# * spell check - cleaned up :)
# * cleanup of unitialized values

# 0.0.16
# * rate limiting: provide mechanisms to back off notifications if provider fails (mainly due to --recently_added)
#     -- twitter: no api for writes. If we receive 403, we assume user hit daily limits (unknown hourly limit). Do not process additional notification until next run.
#     -- boxcar: on failure -- back of the rest of alerts for provider until next run
#     -- prowl: on failure -- back of the rest of alerts for provider until next run
#     -- growl: on failure -- back of the rest of alerts for provider until next run
#     -- pushover: on failure -- back of the rest of alerts for provider until next run
# * --recently_added: 25 results per section created (multiple sections of same type: two sections with type 'shows' = 50 results )
# * --recently_added: SKIP notifications for a video if the addedDate is older than 1 day
# * --recently_added: process backlog (failed alerts) of recently added ( if notification failed and more videos were added before we could notify, keep trying -- but only for 2 days)
# * test_notify=recently_added  -- option to test notification for recently added content (verify provider even works)
# * config.pl: $notify_started and $notify_stopped deprecated: use per provider settings globally (i.e. push_watched, push_watching)
# * recently_added: bugfix - failed when a section only has 1 video.
# * titles added to notifications ( change titles per type in config.pl $push_titles ) prowl, growl, pushover, boxcar, twitter supported
# * Default titles can be changed globally in config.pl ($push_titles)

# 0.0.15
# * added recently_added=[movie,show]  -- notify on recently added items to PMS
# * Twitter added as a provider
    -  requires Net::Twitter::Lite::WithAPIv1_1  ( install with: 'cpan Net::Twitter::Lite::WithAPIv1_1' )
    -  requires Net::OAuth >= 0.28  ( install with: 'cpan Net::OAuth' )
    -  twitter OAUTH required - create a new app @ https://dev.twitter.com/apps
     -- make sure to set set ApplicationType to read/write
# *  config.pl: added  push_watched => 1, push_watching => 1, push_recently_added => 1 to all providers. Enable to disable specific notify types
# * --exclude_user added to all functions. You can specify --exclude_user multiple times.. i.e --exclude_user=user1 --exclude_user=otherUsername
# * Boxcar added as provider
#   - All you need is a registered account on boxcar (valid email)
#   - If enabled, this script with register your boxcar account to the plexWatch service -- simple right?
# * Twitter/OAuth modules ONLY required if you enable twitter (Net::Twitter::Lite::WithAPIv1_1 , Net::OAuth)
# * removed module WWW::Curl::Easy (replaced with LWP which is more standard)
# * removed module URI::Escape (using my own subroutine)
# * --version added -- easier to debug

# 0.0.14
# * --watched -- join the same show title in one line if it was watched into the next day. 
#	I.E. Movie1 watched from 11pm - 1am:  would normally show two lines.. 1 from 11pm-11:59pm and 2 from 12am-1am. Now it will just show one
#

# 0.0.13
# * duration_exact change to durationrr (time precision will be in minutes)
# * --stats time precision will still be seconds
# * formatting options added
#   {time_left}   :: time left until video is done. works only on --watching 
#   - {length}    :: length of video (works for any)
#   - {progress} :: current time watched in video
# * --stats can be used by itself now. No longer required to have --watched
# * Growl added to config.pl -- requires GrowlNotify from http://growl.info/downloads

# 0.0.12
# * code cleanup - merge same routines in sub (&FriendlyName)
# * alert cleanup - easier to update alert format when needed (and more standardized)
   -- $alert_format added to config options (unique for stop and start)
   -- can override on cli with --format_stop="..." and --format_start="..."
   -- list available format options with --format_options
# * cli --watching --watched format can now be edited by the user or specified on the cli
# * config options moved into config.pl -- should be easier to upgrade version without having to edit the Perl script each time
# * config.pl-dist is included --- one must edit and copy it to config.pl
# * File::Basename required -- to load config.pl

# 0.0.11
# * Season/Episode appended to alert.
# * fixed bug in '-watching' cli options. friendly name fixed.

# 0.0.10
# * '-stats' option added to '-watched' - show total watched time per user -- total time and per day
# * '-user' option added to '-watched' and '-watching' -- limit output to a specific user
# * $user_display hash ref added to config - you can now show a 'friendly' username instead of the users email address [excluding @domain.tld]
# * platform title used if exists over platform. I.E. Chrome - Plex/Web (Chrome) will not show 'Plex/Web (Chrome)' -- it was redundant. Roku will still be Roku
# * log file is now hard coded to $data_dir/plexWatch.log instead of $data_dir/$appname.log. Allows users to change $appname to anything or nothing for notification

# 0.0.9
# * -watched will now show the accumulated duration (if a video has been started/stopped multiple time on the same day)
# * -nogrouping added as an option to -watched. It will show the same video multiple times if it has been started/stopped on the same day)

# 0.0.8
# * file locking was broking - multiple copies could run at the same time
# * failed attempts to retrieve xml status could result in false stopped notifications and dupes
# * timeout was way too long any possibly indefinite for sessions status. now 20 seconds.
# -- this might fix the dupe stopped notifications.

# 0.0.7
# * added 'on platform' for alert - i.e. user is watching: movie name on Roku'
# * fixed alerts for prowl when movie has a colon. It was discarding anything after the first colon.

# 0.0.6
# * fixed pushover notifications -- actually include the alert!

# 0.0.5
# info: little bugs, nothing major
#
# * updated Perl doc
# * fixed --show_xml to actually show url when no options are given
# * README.md - Fix install instructions and supply yum/apt-get Perl module howto

# 0.0.4
# * added data_dir in config. Defaults to /opt/plexWeb/ -- this way the script can be run from any location.

# 0.0.3
# * new requirement: Time::ParseDate
# * date ranges for -watched (-start, -stop)
# * specify human date ranges -- Time::ParseDate -- today, yesterday, last week

# 0.0.2;
# * new requirement: use Getopt::Long, Pod::Usage, Fcntl qw(:flock), Fcntl qw(:flock)
# * modified DB insert - using Placeholders and Bind Values
# * added 'xml column' to db - if any info is need later or for easier debugging
# * changed stopped from a boolean to actual epoch - used for duration of watched
# * changed sub InitialzeDB (now initDB) and added initDBtable - ability to add/modify column definitions when needed
# * added use Time::Duration -- duration for watched status
# * verify all content has been notified if nothing is playing
# * added lock just in case via Fcntl qw(:flock)
# * new options: added ability to use cli options via get::opt 
#  - added --watched 
#  - added --watching
#  - added --help
#  - added --show_xml
#  - added --debug
#  - added --notify

# 0.0.1:
# * initial release
